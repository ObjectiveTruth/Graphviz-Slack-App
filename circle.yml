general:
  branches:
    only:
      - master

machine:
  java:
    version: openjdk8
  python:
    version: 2.7.6
  services:
    - docker

dependencies:
  override:
    - docker info
    - sbt universal:packageZipTarball
    - docker build -t objectivetruth/graphvizzer:latest .

  pre:
    - pip install awscli
  post:
    # Used to parse JSON in bash
    - sudo apt-get install -y jq
  cache_directories:
    - ~/.sbt
    - ~/.ivy2
    # Makes sbt resolution faster
    - target/resolution-cache
    - target/streams
    - project/target/resolution-cache
    - project/target/streams

test:
  override:
    - sbt coverage test coverageReport
  post:
    - cp -rv target/test-reports $CIRCLE_TEST_REPORTS/junit
    - cp -rv target/scala-2.11/scoverage-report $CIRCLE_ARTIFACTS
    - bash <(curl -s https://codecov.io/bash)

deployment:
  production:
    branch: master
    commands:
      # Push the new docker image to docker hub
      - docker login -e="$DOCKER_EMAIL" -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD"
      - docker push objectivetruth/graphvizzer:latest
      # Get the instance ID that is currently hosting the MiniDoAllServer
      - aws ec2 describe-instances --filters Name=ip-address,Values=52.0.80.169 --output text --query 'Reservations[0].Instances[0].InstanceId' > /tmp/instance_id
      - cat /tmp/instance_id
      # Terminate the instance
      - aws ec2 terminate-instances --instance-ids $(cat /tmp/instance_id)
