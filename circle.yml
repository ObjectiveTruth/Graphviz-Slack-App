general:
  branches:
    only:
      - master
      - webapp_master

machine:
  python:
    version: 2.7.6
  node:
    version: v6.1.0
  services:
    - docker

dependencies:
  override:
    - pip install awscli
    - docker info
    - npm install codecov --global
    - npm install:
        pwd:
          csci3230-project

test:
  override:
    - npm run-script test-with-coverage-report:
        pwd:
          csci3230-project
    - npm run-script check-style:
        pwd:
          csci3230-project
  post:
    - codecov
        pwd:
          csci3230-project

deployment:
  production:
    branch: master
    commands:
      # Push the new docker image to docker hub
      - docker login -e="$DOCKER_EMAIL" -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD"
      - docker push objectivetruth/graphvizzer:latest
      # Get the instance ID that is currently hosting the MiniDoAllServer
      - aws ec2 describe-instances --filters Name=ip-address,Values=52.0.80.169 --output text --query 'Reservations[0].Instances[0].InstanceId' > /tmp/instance_id
      - cat /tmp/instance_id
      # Terminate the instance
      - aws ec2 terminate-instances --instance-ids $(cat /tmp/instance_id)
